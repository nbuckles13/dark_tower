version: '3.8'

services:
  # PostgreSQL database for persistent storage
  postgres:
    image: postgres:16-alpine
    container_name: dark_tower_postgres
    environment:
      POSTGRES_DB: dark_tower
      POSTGRES_USER: darktower
      POSTGRES_PASSWORD: dev_password_change_in_production
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U darktower -d dark_tower"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dark_tower_network

  # Redis for ephemeral storage and caching
  redis:
    image: redis:7-alpine
    container_name: dark_tower_redis
    command: redis-server --appendonly yes --requirepass dev_password_change_in_production
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dark_tower_network

  # Redis Commander - Web UI for Redis
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: dark_tower_redis_commander
    environment:
      - REDIS_HOSTS=local:redis:6379:0:dev_password_change_in_production
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - dark_tower_network

  # pgAdmin - Web UI for PostgreSQL
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: dark_tower_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@darktower.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "8080:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - dark_tower_network

  # Jaeger - Distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: dark_tower_jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    networks:
      - dark_tower_network

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: dark_tower_prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./infra/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - dark_tower_network

  # Grafana - Metrics visualization
  grafana:
    image: grafana/grafana:latest
    container_name: dark_tower_grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/docker/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - dark_tower_network

  # Auth Controller - Authentication and authorization service
  # Uncomment when ready to run in Docker (currently run from source: cargo run --bin auth-controller)
  # auth-controller:
  #   build:
  #     context: .
  #     dockerfile: infra/docker/auth-controller.Dockerfile
  #   container_name: dark_tower_auth_controller
  #   environment:
  #     - RUST_LOG=info,ac_service=debug
  #     - DATABASE_URL=postgresql://darktower:dev_password_change_in_production@postgres:5432/dark_tower
  #     - REDIS_URL=redis://:dev_password_change_in_production@redis:6379
  #     - AC_MASTER_KEY=${AC_MASTER_KEY}  # REQUIRED: Set in .env (generate with: ./scripts/generate-master-key.sh)
  #     - BIND_ADDRESS=0.0.0.0:8082
  #     - TLS_CERT_PATH=/certs/auth-localhost.crt
  #     - TLS_KEY_PATH=/certs/auth-localhost.key
  #     - OTLP_ENDPOINT=http://jaeger:4317
  #   ports:
  #     - "8082:8082"  # Auth Controller HTTP/3 API
  #   volumes:
  #     - ./infra/docker/certs:/certs:ro  # TLS certificates for HTTPS
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - dark_tower_network

  # Global Controller (placeholder - will be built from source)
  # gc-service:
  #   build:
  #     context: .
  #     dockerfile: infra/docker/gc-service/Dockerfile
  #   container_name: dark_tower_gc_service
  #   environment:
  #     - RUST_LOG=info
  #     - DATABASE_URL=postgresql://darktower:dev_password_change_in_production@postgres:5432/dark_tower
  #     - REDIS_URL=redis://:dev_password_change_in_production@redis:6379
  #   ports:
  #     - "8000:8000"
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - dark_tower_network

  # Meeting Controller (placeholder - will be built from source)
  # mc-service:
  #   build:
  #     context: .
  #     dockerfile: infra/docker/mc-service/Dockerfile
  #   container_name: dark_tower_mc_service
  #   environment:
  #     - RUST_LOG=info
  #     - REDIS_URL=redis://:dev_password_change_in_production@redis:6379
  #   ports:
  #     - "4433:4433/udp"  # QUIC
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - dark_tower_network

  # Media Handler (placeholder - will be built from source)
  # mh-service:
  #   build:
  #     context: .
  #     dockerfile: infra/docker/mh-service/Dockerfile
  #   container_name: dark_tower_mh_service
  #   environment:
  #     - RUST_LOG=info
  #   ports:
  #     - "4434:4434/udp"  # QUIC
  #   networks:
  #     - dark_tower_network

networks:
  dark_tower_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
  pgadmin_data:
