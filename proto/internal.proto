syntax = "proto3";

package dark_tower.internal;

import "signaling.proto";

// ============================================================================
// Meeting Controller <-> Media Handler
// ============================================================================

// Request to register a participant with the media handler
message RegisterParticipant {
  string participant_id = 1;
  string meeting_id = 2;
  repeated dark_tower.signaling.MediaStream streams = 3;
}

// Response to participant registration
message RegisterParticipantResponse {
  string connection_token = 1;
  string media_handler_url = 2;
}

// Routing options for media forwarding
message RoutingOptions {
  bool transcode = 1;
  string target_codec = 2;
  uint32 target_bitrate = 3;
  bool mix_audio = 4;  // Mix multiple audio streams
}

// Cascading destination for multi-handler routing
message CascadeDestination {
  string media_handler_url = 1;
  repeated string destination_participant_ids = 2;  // Participants on this handler
}

// Command to route media between participants (supports multi-handler cascading)
message RouteMediaCommand {
  uint64 source_user_id = 1;  // Source participant (8-byte user ID)
  uint32 source_stream_id = 2;  // Source stream (4-byte subscriber ID)
  repeated string destination_participant_ids = 3;  // Direct destinations on this handler
  repeated CascadeDestination cascade_destinations = 4;  // Destinations on other handlers
  RoutingOptions options = 5;
}

// Media telemetry from media handler to meeting controller
message MediaTelemetry {
  uint64 user_id = 1;  // Source participant (8-byte user ID)
  uint32 stream_id = 2;  // Stream identifier (4-byte)
  uint64 bytes_sent = 3;
  uint64 bytes_received = 4;
  float packet_loss = 5;
  uint32 bitrate = 6;
  uint32 jitter_ms = 7;
  uint64 timestamp = 8;
}

// ============================================================================
// Global Controller <-> Meeting Controller
// ============================================================================

// Capacity information for a meeting controller
message ControllerCapacity {
  uint32 max_meetings = 1;
  uint32 current_meetings = 2;
  uint32 max_participants = 3;
  uint32 current_participants = 4;
}

// Health status of a controller
enum HealthStatus {
  PENDING = 0;    // Just registered, not yet verified
  HEALTHY = 1;
  DEGRADED = 2;
  UNHEALTHY = 3;
  DRAINING = 4;   // Graceful shutdown in progress
}

// MC registration request with both endpoints per ADR-0010
message RegisterMCRequest {
  string id = 1;                      // Unique controller ID
  string region = 2;                  // Deployment region (e.g., "us-east-1")
  string grpc_endpoint = 3;           // gRPC endpoint for GC→MC calls
  string webtransport_endpoint = 4;   // WebTransport endpoint for clients
  uint32 max_meetings = 5;            // Maximum concurrent meetings
  uint32 max_participants = 6;        // Maximum total participants
}

message RegisterMCResponse {
  bool accepted = 1;
  string message = 2;
  uint64 fast_heartbeat_interval_ms = 3;          // 10000ms
  uint64 comprehensive_heartbeat_interval_ms = 4; // 30000ms
}

// Fast heartbeat (10s) - capacity only, minimal payload
message FastHeartbeatRequest {
  string controller_id = 1;
  ControllerCapacity capacity = 2;
  HealthStatus health = 3;
}

// Comprehensive heartbeat (30s) - full metrics
message ComprehensiveHeartbeatRequest {
  string controller_id = 1;
  ControllerCapacity capacity = 2;
  HealthStatus health = 3;
  float cpu_usage_percent = 4;
  float memory_usage_percent = 5;
}

// ============================================================================
// Service Definitions
// ============================================================================

// Media handler service (Meeting Controller -> Media Handler)
service MediaHandlerService {
  rpc Register(RegisterParticipant) returns (RegisterParticipantResponse);
  rpc RouteMedia(RouteMediaCommand) returns (RouteMediaResponse);
  rpc StreamTelemetry(stream MediaTelemetry) returns (TelemetryAck);
}

message RouteMediaResponse {
  bool success = 1;
  string error_message = 2;
}

message TelemetryAck {
  bool received = 1;
}

// Meeting controller service (Global Controller -> Meeting Controller)
service MeetingControllerService {
  // ADR-0010 Section 4a: GC notifies MC of meeting assignment with MH assignments
  rpc AssignMeetingWithMh(AssignMeetingWithMhRequest) returns (AssignMeetingWithMhResponse);
}

// Request to notify GC that a meeting has ended
message NotifyMeetingEndedRequest {
  string meeting_id = 1;  // Meeting that ended
  string region = 2;      // Region where the meeting was hosted
}

// Response to meeting ended notification
message NotifyMeetingEndedResponse {
  bool acknowledged = 1;
}

// MC→GC service (MCs call this to register and heartbeat)
service GlobalControllerService {
  rpc RegisterMC(RegisterMCRequest) returns (RegisterMCResponse);
  rpc FastHeartbeat(FastHeartbeatRequest) returns (HeartbeatResponse);
  rpc ComprehensiveHeartbeat(ComprehensiveHeartbeatRequest) returns (HeartbeatResponse);
  rpc NotifyMeetingEnded(NotifyMeetingEndedRequest) returns (NotifyMeetingEndedResponse);
}

// MH→GC service (MHs call this to register and send load reports)
service MediaHandlerRegistryService {
  // Register a new media handler with the global controller
  rpc RegisterMH(RegisterMHRequest) returns (RegisterMHResponse);
  // Send a load report (heartbeat with capacity/health info)
  rpc SendLoadReport(MHLoadReportRequest) returns (MHLoadReportResponse);
}

message HeartbeatResponse {
  bool acknowledged = 1;
  uint64 timestamp = 2;
}

// ============================================================================
// ADR-0010 Section 4a: GC→MC Meeting Assignment with MH Assignments
// ============================================================================

// Role of a media handler in a meeting
enum MhRole {
  MH_ROLE_UNSPECIFIED = 0;
  MH_ROLE_PRIMARY = 1;
  MH_ROLE_BACKUP = 2;
}

// Reason for MC rejecting a meeting assignment
enum RejectionReason {
  REJECTION_REASON_UNSPECIFIED = 0;
  REJECTION_REASON_AT_CAPACITY = 1;
  REJECTION_REASON_DRAINING = 2;
  REJECTION_REASON_UNHEALTHY = 3;
}

// Media handler assignment for a meeting
message MhAssignment {
  string mh_id = 1;                   // Media handler ID
  string webtransport_endpoint = 2;    // WebTransport endpoint for clients
  MhRole role = 3;                     // Primary or backup role
}

// Request from GC to MC to assign a meeting with MH assignments
message AssignMeetingWithMhRequest {
  string meeting_id = 1;               // Meeting being assigned
  repeated MhAssignment mh_assignments = 2;  // MH assignments for this meeting
  string requesting_gc_id = 3;         // ID of the GC making the request
}

// Response from MC to GC for meeting assignment
message AssignMeetingWithMhResponse {
  bool accepted = 1;                   // Whether the MC accepted the assignment
  RejectionReason rejection_reason = 2; // Reason if not accepted
}

// ============================================================================
// ADR-0010 Section 4a: MH Registration and Load Reports
// ============================================================================

// Request to register a media handler with the global controller
message RegisterMHRequest {
  string handler_id = 1;               // Unique handler identifier
  string region = 2;                   // Deployment region (e.g., "us-east-1")
  string webtransport_endpoint = 3;    // WebTransport endpoint for client connections
  string grpc_endpoint = 4;            // gRPC endpoint for MC→MH communication
  uint32 max_streams = 5;              // Maximum concurrent streams
}

// Response to MH registration
message RegisterMHResponse {
  bool accepted = 1;
  string message = 2;
  uint64 load_report_interval_ms = 3;  // How often to send load reports (e.g., 10000ms)
}

// Load report from MH to GC (heartbeat with capacity info)
message MHLoadReportRequest {
  string handler_id = 1;               // Handler sending the report
  uint32 current_streams = 2;          // Current number of active streams
  HealthStatus health = 3;             // Current health status
  float cpu_usage_percent = 4;         // CPU usage (0-100)
  float memory_usage_percent = 5;      // Memory usage (0-100)
  float bandwidth_usage_percent = 6;   // Bandwidth usage (0-100)
}

// Response to load report
message MHLoadReportResponse {
  bool acknowledged = 1;
  uint64 timestamp = 2;
}
